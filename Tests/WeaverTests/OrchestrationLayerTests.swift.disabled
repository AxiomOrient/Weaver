import Testing
import Foundation
@testable import Weaver

// MARK: - Orchestration Layer í†µí•© í…ŒìŠ¤íŠ¸

@Suite("Orchestration Layer - ì»¤ë„, ì „ì—­ ìƒíƒœ, í”Œë«í¼ í˜¸í™˜ì„±")
struct OrchestrationLayerTests {
    
    // MARK: - WeaverKernel ì´ì¤‘ ì´ˆê¸°í™” ì „ëµ í…ŒìŠ¤íŠ¸
    
    @Test("Realistic ì „ëµ - ì¦‰ì‹œ ì‚¬ìš© ê°€ëŠ¥")
    func testRealisticStrategyImmediateAvailability() async throws {
        let modules = [TestModule()]
        let kernel = WeaverKernel(modules: modules, strategy: .realistic)
        
        // ë¹Œë“œ ì‹œì‘
        await kernel.build()
        
        // ì¦‰ì‹œ ì‚¬ìš© ê°€ëŠ¥í•´ì•¼ í•¨
        let service = await kernel.safeResolve(ServiceKey.self)
        #expect(service.isDefaultValue == false)
        
        // ìƒíƒœ í™•ì¸
        let state = await kernel.currentState
        if case .ready = state {
            // ì„±ê³µ
        } else {
            #expect(Bool(false), "Realistic ì „ëµì—ì„œëŠ” ì¦‰ì‹œ ready ìƒíƒœê°€ ë˜ì–´ì•¼ í•¨")
        }
        
        await kernel.shutdown()
    }
    
    @Test("Immediate ì „ëµ - ì™„ì „ ì´ˆê¸°í™” í›„ ì‚¬ìš©")
    func testImmediateStrategyFullInitialization() async throws {
        let modules = [TestModule()]
        let kernel = WeaverKernel(modules: modules, strategy: .immediate)
        
        // ìƒíƒœ ìŠ¤íŠ¸ë¦¼ ê´€ì°°
        var stateChanges: [LifecycleState] = []
        let stateTask = Task {
            for await state in kernel.stateStream {
                stateChanges.append(state)
                if case .ready = state {
                    break
                }
            }
        }
        
        // ë¹Œë“œ ì‹œì‘
        await kernel.build()
        
        // ì¤€ë¹„ ì™„ë£Œ ëŒ€ê¸°
        _ = try await kernel.waitForReady(timeout: nil)
        
        // ìƒíƒœ ë³€í™” í™•ì¸
        stateTask.cancel()
        #expect(stateChanges.contains { if case .configuring = $0 { return true }; return false })
        #expect(stateChanges.contains { if case .ready = $0 { return true }; return false })
        
        await kernel.shutdown()
    }
    
    @Test("ì»¤ë„ ìƒíƒœ ìŠ¤íŠ¸ë¦¼ ê´€ì°°")
    func testKernelStateStreamObservation() async throws {
        let modules = [TestModule()]
        let kernel = WeaverKernel(modules: modules, strategy: .immediate)
        
        var observedStates: [LifecycleState] = []
        let observationTask = Task {
            for await state in kernel.stateStream {
                observedStates.append(state)
                if case .shutdown = state {
                    break
                }
            }
        }
        
        // ìƒëª…ì£¼ê¸° ì‹¤í–‰
        await kernel.build()
        _ = try await kernel.waitForReady(timeout: nil)
        await kernel.shutdown()
        
        // ê´€ì°° ì™„ë£Œ ëŒ€ê¸°
        await observationTask.value
        
        // ì˜ˆìƒëœ ìƒíƒœ ì „í™˜ í™•ì¸
        #expect(observedStates.count >= 3) // idle, configuring, ready, shutdown
        #expect(observedStates.contains { if case .idle = $0 { return true }; return false })
        #expect(observedStates.contains { if case .configuring = $0 { return true }; return false })
        #expect(observedStates.contains { if case .ready = $0 { return true }; return false })
        #expect(observedStates.contains { if case .shutdown = $0 { return true }; return false })
    }
    
    // MARK: - WeaverGlobalState ì „ì—­ ìƒíƒœ ê´€ë¦¬ í…ŒìŠ¤íŠ¸
    
    @Test("ì „ì—­ ì»¤ë„ ì„¤ì • ë° ìƒíƒœ ë™ê¸°í™”")
    func testGlobalKernelManagement() async throws {
        let globalState = WeaverGlobalState.shared
        
        // ì´ˆê¸° ìƒíƒœ í™•ì¸
        let initialKernel = await globalState.getGlobalKernel()
        #expect(initialKernel == nil)
        
        // ì»¤ë„ ì„¤ì •
        let modules = [TestModule()]
        let kernel = WeaverKernel(modules: modules, strategy: .realistic)
        await globalState.setGlobalKernel(kernel)
        
        // ì„¤ì •ëœ ì»¤ë„ í™•ì¸
        let setKernel = await globalState.getGlobalKernel()
        #expect(setKernel != nil)
        
        // ìƒíƒœ ë™ê¸°í™” í™•ì¸
        await kernel.build()
        let kernelState = await globalState.currentKernelState
        if case .ready = kernelState {
            // ì„±ê³µ
        } else {
            #expect(Bool(false), "ì»¤ë„ ìƒíƒœê°€ ë™ê¸°í™”ë˜ì§€ ì•ŠìŒ")
        }
        
        // ì •ë¦¬
        await kernel.shutdown()
        await globalState.setGlobalKernel(nil)
    }
    
    @Test("3ë‹¨ê³„ Fallback ì‹œìŠ¤í…œ ê²€ì¦")
    func testThreeStageFallbackSystem() async throws {
        let globalState = WeaverGlobalState.shared
        
        // 1ë‹¨ê³„: Preview í™˜ê²½ ì‹œë®¬ë ˆì´ì…˜ (ì‹¤ì œë¡œëŠ” ì–´ë ¤ìš°ë¯€ë¡œ ë¡œì§ ê²€ì¦)
        // 2ë‹¨ê³„: ì „ì—­ ì»¤ë„ ì—†ìŒ
        await globalState.setGlobalKernel(nil)
        let serviceWithoutKernel = await globalState.safeResolve(ServiceKey.self)
        #expect(serviceWithoutKernel.isDefaultValue == true)
        
        // 3ë‹¨ê³„: ì „ì—­ ì»¤ë„ ìˆìŒ
        let modules = [TestModule()]
        let kernel = WeaverKernel(modules: modules, strategy: .realistic)
        await globalState.setGlobalKernel(kernel)
        await kernel.build()
        
        let serviceWithKernel = await globalState.safeResolve(ServiceKey.self)
        #expect(serviceWithKernel.isDefaultValue == false)
        
        // ì •ë¦¬
        await kernel.shutdown()
        await globalState.setGlobalKernel(nil)
    }
    
    // MARK: - PlatformAppropriateLock í”Œë«í¼ í˜¸í™˜ì„± í…ŒìŠ¤íŠ¸
    
    @Test("iOS 15/16 í”Œë«í¼ë³„ ì ê¸ˆ ë©”ì»¤ë‹ˆì¦˜ ê²€ì¦")
    func testPlatformSpecificLockMechanism() async throws {
        let lock = PlatformAppropriateLock(initialState: 0)
        
        // ì ê¸ˆ ë©”ì»¤ë‹ˆì¦˜ ì •ë³´ í™•ì¸
        let lockInfo = lock.lockMechanismInfo
        
        if #available(iOS 16.0, macOS 13.0, tvOS 16.0, watchOS 9.0, *) {
            #expect(lockInfo.contains("OSAllocatedUnfairLock"))
        } else {
            #expect(lockInfo.contains("NSLock"))
        }
        
        print("ğŸ”’ ì‚¬ìš© ì¤‘ì¸ ì ê¸ˆ ë©”ì»¤ë‹ˆì¦˜: \(lockInfo)")
    }
    
    @Test("í”Œë«í¼ ì ê¸ˆ ë™ì‹œì„± ì•ˆì „ì„± ê²€ì¦")
    func testPlatformLockConcurrencySafety() async throws {
        let lock = PlatformAppropriateLock(initialState: 0)
        let iterations = 1000
        
        // ë™ì‹œ ì¦ê°€ ì‘ì—…
        await withTaskGroup(of: Void.self) { group in
            for _ in 0..<iterations {
                group.addTask {
                    lock.withLock { state in
                        state += 1
                    }
                }
            }
        }
        
        // ìµœì¢… ê°’ í™•ì¸
        let finalValue = lock.withLock { $0 }
        #expect(finalValue == iterations)
    }
    
    @Test("í”Œë«í¼ ì ê¸ˆ ì„±ëŠ¥ ë²¤ì¹˜ë§ˆí¬")
    func testPlatformLockPerformance() async throws {
        let lock = PlatformAppropriateLock(initialState: 0)
        let iterations = 10000
        
        let startTime = CFAbsoluteTimeGetCurrent()
        
        for _ in 0..<iterations {
            lock.withLock { state in
                state += 1
            }
        }
        
        let duration = CFAbsoluteTimeGetCurrent() - startTime
        let averageTime = duration / Double(iterations) * 1_000_000 // ë§ˆì´í¬ë¡œì´ˆ
        
        print("ğŸš€ í‰ê·  ì ê¸ˆ ì‹œê°„: \(String(format: "%.3f", averageTime))Î¼s")
        #expect(averageTime < 10.0, "í‰ê·  ì ê¸ˆ ì‹œê°„ì´ 10Î¼së¥¼ ì´ˆê³¼í•©ë‹ˆë‹¤")
    }
    
    // MARK: - WeakBox ì•½í•œ ì°¸ì¡° ê´€ë¦¬ í…ŒìŠ¤íŠ¸
    
    @Test("WeakBox ìƒëª…ì£¼ê¸° ê´€ë¦¬")
    func testWeakBoxLifecycleManagement() async throws {
        var testObject: TestObject? = TestObject(id: "test")
        let weakBox = WeakBox(testObject!)
        
        // ì´ˆê¸° ìƒíƒœ í™•ì¸
        let isAliveInitially = await weakBox.isAlive
        #expect(isAliveInitially == true)
        
        let initialValue = await weakBox.getValue()
        #expect(initialValue?.id == "test")
        
        // ê°•í•œ ì°¸ì¡° í•´ì œ
        testObject = nil
        
        // ê°€ë¹„ì§€ ì»¬ë ‰ì…˜ ìœ ë„
        for _ in 0..<10 {
            _ = Array(0..<1000).map { _ in UUID() }
        }
        
        // ì•½ê°„ì˜ ì§€ì—° í›„ ìƒíƒœ í™•ì¸
        try await Task.sleep(nanoseconds: 100_000_000) // 0.1ì´ˆ
        
        let isAliveAfterGC = await weakBox.isAlive
        let valueAfterGC = await weakBox.getValue()
        
        // í•´ì œë˜ì—ˆì„ ê°€ëŠ¥ì„±ì´ ë†’ìŒ (ë³´ì¥ë˜ì§€ëŠ” ì•ŠìŒ)
        if !isAliveAfterGC {
            #expect(valueAfterGC == nil)
        }
    }
    
    @Test("WeakBoxCollection ìë™ ì •ë¦¬")
    func testWeakBoxCollectionCleanup() async throws {
        let collection = WeakBoxCollection<String, TestObject>()
        
        // ê°ì²´ë“¤ ì¶”ê°€
        var objects: [TestObject] = []
        for i in 0..<10 {
            let object = TestObject(id: "test\(i)")
            objects.append(object)
            await collection.set(object, for: "key\(i)")
        }
        
        // ì´ˆê¸° ë©”íŠ¸ë¦­ í™•ì¸
        let initialMetrics = await collection.getMetrics()
        #expect(initialMetrics.totalWeakReferences == 10)
        #expect(initialMetrics.aliveWeakReferences == 10)
        
        // ì¼ë¶€ ê°ì²´ í•´ì œ
        objects.removeFirst(5)
        
        // ê°€ë¹„ì§€ ì»¬ë ‰ì…˜ ìœ ë„
        for _ in 0..<10 {
            _ = Array(0..<1000).map { _ in UUID() }
        }
        
        // ì •ë¦¬ ì‹¤í–‰
        let cleanedCount = await collection.cleanup()
        
        // ì •ë¦¬ í›„ ë©”íŠ¸ë¦­ í™•ì¸
        let finalMetrics = await collection.getMetrics()
        print("ğŸ§¹ ì •ë¦¬ëœ ì°¸ì¡° ìˆ˜: \(cleanedCount)")
        print("ğŸ“Š ìµœì¢… ë©”íŠ¸ë¦­: \(finalMetrics)")
        
        #expect(finalMetrics.totalWeakReferences <= initialMetrics.totalWeakReferences)
    }
    
    // MARK: - @Inject í”„ë¡œí¼í‹° ë˜í¼ í…ŒìŠ¤íŠ¸
    
    @Test("@Inject í”„ë¡œí¼í‹° ë˜í¼ ì•ˆì „í•œ í˜¸ì¶œ")
    func testInjectPropertyWrapperSafeCall() async throws {
        // ì „ì—­ ì»¤ë„ ì„¤ì •
        let modules = [TestModule()]
        let kernel = WeaverKernel(modules: modules, strategy: .realistic)
        await Weaver.setGlobalKernel(kernel)
        await kernel.build()
        
        // @Inject ì‚¬ìš© í´ë˜ìŠ¤
        class TestClient {
            @Inject(ServiceKey.self) private var service
            
            func getService() async -> Service {
                await service()
            }
        }
        
        let client = TestClient()
        let service = await client.getService()
        #expect(service.isDefaultValue == false)
        
        // ì •ë¦¬
        await kernel.shutdown()
        await Weaver.setGlobalKernel(nil)
    }
    
    // MARK: - í†µí•© ì‹œë‚˜ë¦¬ì˜¤ í…ŒìŠ¤íŠ¸
    
    @Test("ì‹¤ì œ ì•± ì‹œì‘ ì‹œë®¬ë ˆì´ì…˜")
    func testRealAppStartupSimulation() async throws {
        // 1. ì•± ì‹œì‘ (realistic ì „ëµ)
        let modules = [
            LoggingModule(),
            ConfigModule(),
            AnalyticsModule(),
            NetworkModule()
        ]
        let kernel = WeaverKernel(modules: modules, strategy: .realistic)
        
        // 2. ì „ì—­ ì„¤ì •
        await Weaver.setGlobalKernel(kernel)
        
        // 3. ë¹Œë“œ ì‹œì‘ (ì¦‰ì‹œ ì‚¬ìš© ê°€ëŠ¥)
        await kernel.build()
        
        // 4. ì¦‰ì‹œ ì˜ì¡´ì„± ì‚¬ìš© ê°€ëŠ¥ ê²€ì¦
        @Inject(LoggerServiceKey.self) var logger
        let log = await logger()
        #expect(log != nil)
        
        // 5. ë°±ê·¸ë¼ìš´ë“œ ì´ˆê¸°í™” ì™„ë£Œ ëŒ€ê¸°
        _ = try await kernel.waitForReady(timeout: nil)
        
        // 6. ëª¨ë“  ì„œë¹„ìŠ¤ ì‚¬ìš© ê°€ëŠ¥ ê²€ì¦
        @Inject(NetworkServiceKey.self) var network
        let networkService = await network()
        #expect(networkService != nil)
        
        // 7. ì •ë¦¬
        await kernel.shutdown()
        await Weaver.setGlobalKernel(nil)
    }
}

// MARK: - í…ŒìŠ¤íŠ¸ ì§€ì› íƒ€ì…ë“¤

extension OrchestrationLayerTests {
    
    // DependencyKey ì •ì˜ë“¤
    struct ServiceKey: DependencyKey {
        typealias Value = Service
        static var defaultValue: Service { NullService(isDefaultValue: true) }
    }
    
    struct LoggerServiceKey: DependencyKey {
        typealias Value = LoggerService
        static var defaultValue: LoggerService { LoggerService() }
    }
    
    struct NetworkServiceKey: DependencyKey {
        typealias Value = NetworkService
        static var defaultValue: NetworkService { NetworkService() }
    }
    
    // í…ŒìŠ¤íŠ¸ìš© ëª¨ë“ˆë“¤
    struct TestModule: Module {
        func configure(_ builder: WeaverBuilder) async {
            await builder.register(ServiceKey.self) { _ in TestService() }
        }
    }
    
    struct LoggingModule: Module {
        func configure(_ builder: WeaverBuilder) async {
            await builder.register(LoggerServiceKey.self, scope: .appService) { _ in
                LoggerService()
            }
        }
    }
    
    struct ConfigModule: Module {
        func configure(_ builder: WeaverBuilder) async {
            // ì„¤ì • ì„œë¹„ìŠ¤ ë“±ë¡
        }
    }
    
    struct AnalyticsModule: Module {
        func configure(_ builder: WeaverBuilder) async {
            // ë¶„ì„ ì„œë¹„ìŠ¤ ë“±ë¡
        }
    }
    
    struct NetworkModule: Module {
        func configure(_ builder: WeaverBuilder) async {
            await builder.register(NetworkServiceKey.self, scope: .appService) { _ in
                NetworkService()
            }
        }
    }
    
    // í…ŒìŠ¤íŠ¸ìš© ì„œë¹„ìŠ¤ë“¤
    final class LoggerService: Sendable {
        init() {}
    }
    
    final class NetworkService: Sendable {
        init() {}
    }
    
    // WeakBox í…ŒìŠ¤íŠ¸ìš© ê°ì²´
    final class TestObject: Sendable {
        let id: String
        
        init(id: String) {
            self.id = id
        }
    }
}