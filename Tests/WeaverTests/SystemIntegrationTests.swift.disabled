import Testing
import Foundation
@testable import Weaver

// MARK: - ì‹œìŠ¤í…œ í†µí•© í…ŒìŠ¤íŠ¸

@Suite("System Integration - ì „ì²´ ì‹œìŠ¤í…œ í†µí•© ê²€ì¦")
struct SystemIntegrationTests {
    
    // MARK: - ì‹¤ì œ ì•± ì‹œë‚˜ë¦¬ì˜¤ ì‹œë®¬ë ˆì´ì…˜
    
    @Test("ì™„ì „í•œ ì•± ìƒëª…ì£¼ê¸° ì‹œë®¬ë ˆì´ì…˜")
    func testCompleteAppLifecycleSimulation() async throws {
        // 1. ì•± ì‹œì‘ - ëª¨ë“ˆ ì •ì˜
        let modules = [
            LoggingModule(),      // Layer 0: ë¡œê¹…
            ConfigModule(),       // Layer 1: ì„¤ì •
            AnalyticsModule(),    // Layer 2: ë¶„ì„
            NetworkModule(),      // Layer 3: ë„¤íŠ¸ì›Œí¬
            SecurityModule(),     // Layer 4: ë³´ì•ˆ
            DataModule(),         // Layer 5: ë°ì´í„°
            BusinessModule(),     // Layer 6: ë¹„ì¦ˆë‹ˆìŠ¤
            UIModule()           // Layer 7: UI
        ]
        
        // 2. ì»¤ë„ ìƒì„± ë° ì „ì—­ ì„¤ì •
        let kernel = WeaverKernel(modules: modules, strategy: .realistic)
        await Weaver.setGlobalKernel(kernel)
        
        // 3. ì•± ë¹Œë“œ (ì¦‰ì‹œ ì‚¬ìš© ê°€ëŠ¥)
        await kernel.build()
        
        // 4. ì¦‰ì‹œ í•µì‹¬ ì„œë¹„ìŠ¤ ì‚¬ìš© ê°€ëŠ¥ ê²€ì¦
        @Inject(LoggerServiceKey.self) var logger
        @Inject(ConfigServiceKey.self) var config
        
        let log = await logger()
        let configuration = await config()
        
        #expect(log != nil)
        #expect(configuration != nil)
        
        // 5. ë°±ê·¸ë¼ìš´ë“œ ì´ˆê¸°í™” ì™„ë£Œ ëŒ€ê¸°
        _ = try await kernel.waitForReady(timeout: nil)
        
        // 6. ëª¨ë“  ê³„ì¸µ ì„œë¹„ìŠ¤ ì‚¬ìš© ê°€ëŠ¥ ê²€ì¦
        @Inject(NetworkServiceKey.self) var network
        @Inject(SecurityServiceKey.self) var security
        @Inject(DataServiceKey.self) var data
        @Inject(BusinessServiceKey.self) var business
        @Inject(UIServiceKey.self) var ui
        
        let networkService = await network()
        let securityService = await security()
        let dataService = await data()
        let businessService = await business()
        let uiService = await ui()
        
        #expect(networkService != nil)
        #expect(securityService != nil)
        #expect(dataService != nil)
        #expect(businessService != nil)
        #expect(uiService != nil)
        
        // 7. ì•± ìƒëª…ì£¼ê¸° ì´ë²¤íŠ¸ ì‹œë®¬ë ˆì´ì…˜
        await Weaver.handleAppLifecycleEvent(.didEnterBackground)
        await Weaver.handleAppLifecycleEvent(.willEnterForeground)
        
        // 8. ì •ë¦¬
        await kernel.shutdown()
        await Weaver.setGlobalKernel(nil)
    }
    
    @Test("ëŒ€ê·œëª¨ ì˜ì¡´ì„± ê·¸ë˜í”„ ì²˜ë¦¬")
    func testLargeScaleDependencyGraph() async throws {
        let builder = WeaverContainer.builder()
        
        // 100ê°œì˜ ì„œë¡œ ë‹¤ë¥¸ ì˜ì¡´ì„± ë“±ë¡
        for i in 0..<100 {
            await builder.register(DynamicServiceKey(id: i).self) { _ in
                DynamicService(id: i)
            }
        }
        
        // ì˜ì¡´ì„± ì²´ì¸ ìƒì„± (ê° ì„œë¹„ìŠ¤ê°€ ì´ì „ ì„œë¹„ìŠ¤ì— ì˜ì¡´)
        for i in 1..<50 {
            await builder.register(ChainedServiceKey(id: i).self) { resolver in
                let dependency = try await resolver.resolve(ChainedServiceKey(id: i-1).self)
                return ChainedService(id: i, dependency: dependency)
            }
        }
        
        let container = await builder.build()
        
        // ì„±ëŠ¥ ì¸¡ì •
        let startTime = CFAbsoluteTimeGetCurrent()
        
        // ëª¨ë“  ë…ë¦½ ì„œë¹„ìŠ¤ í•´ê²°
        for i in 0..<100 {
            _ = try await container.resolve(DynamicServiceKey(id: i).self)
        }
        
        // ì²´ì¸ ë ì„œë¹„ìŠ¤ í•´ê²° (ì „ì²´ ì²´ì¸ ì´ˆê¸°í™”)
        let chainEnd = try await container.resolve(ChainedServiceKey(id: 49).self)
        #expect(chainEnd.id == 49)
        #expect(chainEnd.dependency?.id == 48)
        
        let duration = CFAbsoluteTimeGetCurrent() - startTime
        print("ğŸš€ ëŒ€ê·œëª¨ ì˜ì¡´ì„± ê·¸ë˜í”„ ì²˜ë¦¬ ì‹œê°„: \(String(format: "%.3f", duration))ì´ˆ")
        
        #expect(duration < 1.0, "ëŒ€ê·œëª¨ ì˜ì¡´ì„± ê·¸ë˜í”„ ì²˜ë¦¬ê°€ 1ì´ˆë¥¼ ì´ˆê³¼í•©ë‹ˆë‹¤")
        
        await container.shutdown()
    }
    
    // MARK: - ë™ì‹œì„± ìŠ¤íŠ¸ë ˆìŠ¤ í…ŒìŠ¤íŠ¸
    
    @Test("ê·¹í•œ ë™ì‹œì„± ìŠ¤íŠ¸ë ˆìŠ¤ í…ŒìŠ¤íŠ¸")
    func testExtremeConcurrencyStress() async throws {
        let container = await WeaverContainer.builder()
            .register(ServiceKey.self, scope: .container) { _ in
                // ì˜ë„ì ì¸ ì§€ì—°ìœ¼ë¡œ ê²½ìŸ ì¡°ê±´ ìœ ë„
                try await Task.sleep(nanoseconds: 1_000_000) // 1ms
                return TestService()
            }
            .register(TransientServiceKey.self) { _ in
                return TestService()
            }
            .build()
        
        let concurrentTasks = 1000
        let startTime = CFAbsoluteTimeGetCurrent()
        
        // 1000ê°œ ë™ì‹œ ìš”ì²­
        try await withThrowingTaskGroup(of: (Service, Service).self) { group in
            for _ in 0..<concurrentTasks {
                group.addTask {
                    async let containerScoped = container.resolve(ServiceKey.self)
                    async let transient = container.resolve(TransientServiceKey.self)
                    return try await (containerScoped, transient)
                }
            }
            
            var containerScopedIds: Set<UUID> = []
            var transientIds: Set<UUID> = []
            
            for try await (containerScoped, transient) in group {
                containerScopedIds.insert(containerScoped.id)
                transientIds.insert(transient.id)
            }
            
            // Container ìŠ¤ì½”í”„ëŠ” ëª¨ë‘ ë™ì¼í•œ ì¸ìŠ¤í„´ìŠ¤
            #expect(containerScopedIds.count == 1)
            
            // TransientëŠ” ê°ê° ë‹¤ë¥¸ ì¸ìŠ¤í„´ìŠ¤ì¼ ìˆ˜ ìˆìŒ
            print("ğŸ”„ Container ìŠ¤ì½”í”„ ì¸ìŠ¤í„´ìŠ¤ ìˆ˜: \(containerScopedIds.count)")
            print("ğŸ”„ Transient ì¸ìŠ¤í„´ìŠ¤ ìˆ˜: \(transientIds.count)")
        }
        
        let duration = CFAbsoluteTimeGetCurrent() - startTime
        print("âš¡ ê·¹í•œ ë™ì‹œì„± í…ŒìŠ¤íŠ¸ ì™„ë£Œ ì‹œê°„: \(String(format: "%.3f", duration))ì´ˆ")
        
        await container.shutdown()
    }
    
    // MARK: - ë©”ëª¨ë¦¬ ì••ë°• ì‹œë‚˜ë¦¬ì˜¤
    
    @Test("ë©”ëª¨ë¦¬ ì••ë°• ìƒí™© ë³µêµ¬ í…ŒìŠ¤íŠ¸")
    func testMemoryPressureRecovery() async throws {
        let container = await WeaverContainer.builder()
            .registerWeak(WeakServiceKey.self) { _ in WeakService() }
            .register(ServiceKey.self, scope: .cached) { _ in TestService() }
            .build()
        
        // ëŒ€ëŸ‰ ì¸ìŠ¤í„´ìŠ¤ ìƒì„±ìœ¼ë¡œ ë©”ëª¨ë¦¬ ì••ë°• ìœ ë„
        var weakInstances: [WeakService] = []
        var regularInstances: [Service] = []
        
        for _ in 0..<5000 {
            let weakInstance = try await container.resolve(WeakServiceKey.self)
            let regularInstance = try await container.resolve(ServiceKey.self)
            
            weakInstances.append(weakInstance)
            regularInstances.append(regularInstance)
        }
        
        // ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ í™•ì¸
        let initialMetrics = await container.getMetrics()
        print("ğŸ“Š ì´ˆê¸° ë©”íŠ¸ë¦­: \(initialMetrics)")
        
        // ì°¸ì¡° í•´ì œ
        weakInstances.removeAll()
        regularInstances.removeAll()
        
        // ê°€ë¹„ì§€ ì»¬ë ‰ì…˜ ìœ ë„
        for _ in 0..<20 {
            _ = Array(0..<10000).map { _ in UUID() }
        }
        
        // ê°•ì œ ë©”ëª¨ë¦¬ ì •ë¦¬
        await container.performMemoryCleanup(forced: true)
        
        // ì •ë¦¬ í›„ ë©”íŠ¸ë¦­ í™•ì¸
        let finalMetrics = await container.getMetrics()
        print("ğŸ“Š ì •ë¦¬ í›„ ë©”íŠ¸ë¦­: \(finalMetrics)")
        
        #expect(finalMetrics.weakReferences.deallocatedWeakReferences >= 0)
        
        await container.shutdown()
    }
    
    // MARK: - ì—ëŸ¬ ë³µêµ¬ ì‹œë‚˜ë¦¬ì˜¤
    
    @Test("ë¶€ë¶„ ì‹¤íŒ¨ ìƒí™©ì—ì„œ ì‹œìŠ¤í…œ ë³µêµ¬")
    func testPartialFailureRecovery() async throws {
        let container = await WeaverContainer.builder()
            .register(ReliableServiceKey.self) { _ in ReliableService() }
            .register(UnreliableServiceKey.self) { _ in
                // 50% í™•ë¥ ë¡œ ì‹¤íŒ¨
                if Bool.random() {
                    throw TestError.factoryFailed
                }
                return UnreliableService()
            }
            .register(DependentServiceKey.self) { resolver in
                let reliable = try await resolver.resolve(ReliableServiceKey.self)
                
                // ë¶ˆì•ˆì •í•œ ì„œë¹„ìŠ¤ëŠ” ì•ˆì „í•˜ê²Œ ì²˜ë¦¬
                let unreliable: UnreliableService?
                do {
                    unreliable = try await resolver.resolve(UnreliableServiceKey.self)
                } catch {
                    unreliable = nil // ì‹¤íŒ¨í•´ë„ ê³„ì† ì§„í–‰
                }
                
                return DependentService(reliable: reliable, unreliable: unreliable)
            }
            .build()
        
        var successCount = 0
        var partialSuccessCount = 0
        
        // 100ë²ˆ ì‹œë„
        for _ in 0..<100 {
            do {
                let service = try await container.resolve(DependentServiceKey.self)
                if service.unreliable != nil {
                    successCount += 1
                } else {
                    partialSuccessCount += 1
                }
            } catch {
                // ì™„ì „ ì‹¤íŒ¨ëŠ” ì—†ì–´ì•¼ í•¨ (reliable ì„œë¹„ìŠ¤ëŠ” í•­ìƒ ì„±ê³µ)
                #expect(Bool(false), "ì˜ˆìƒì¹˜ ëª»í•œ ì™„ì „ ì‹¤íŒ¨: \(error)")
            }
        }
        
        print("âœ… ì™„ì „ ì„±ê³µ: \(successCount)íšŒ")
        print("âš ï¸ ë¶€ë¶„ ì„±ê³µ: \(partialSuccessCount)íšŒ")
        
        #expect(successCount + partialSuccessCount == 100)
        #expect(partialSuccessCount > 0, "ë¶€ë¶„ ì‹¤íŒ¨ ì‹œë‚˜ë¦¬ì˜¤ê°€ ë°œìƒí•˜ì§€ ì•ŠìŒ")
        
        await container.shutdown()
    }
    
    // MARK: - ì„±ëŠ¥ ë²¤ì¹˜ë§ˆí¬
    
    @Test("ì „ì²´ ì‹œìŠ¤í…œ ì„±ëŠ¥ ë²¤ì¹˜ë§ˆí¬")
    func benchmarkOverallSystemPerformance() async throws {
        let monitor = WeaverPerformanceMonitor(enabled: true)
        
        // ë³µì¡í•œ ì˜ì¡´ì„± ê·¸ë˜í”„ êµ¬ì„±
        let container = await WeaverContainer.builder()
            .register(Layer0ServiceKey.self, scope: .container) { _ in Layer0Service() }
            .register(Layer1ServiceKey.self, scope: .container) { resolver in
                let layer0 = try await resolver.resolve(Layer0ServiceKey.self)
                return Layer1Service(dependency: layer0)
            }
            .register(Layer2ServiceKey.self, scope: .container) { resolver in
                let layer1 = try await resolver.resolve(Layer1ServiceKey.self)
                return Layer2Service(dependency: layer1)
            }
            .register(Layer3ServiceKey.self, scope: .container) { resolver in
                let layer2 = try await resolver.resolve(Layer2ServiceKey.self)
                return Layer3Service(dependency: layer2)
            }
            .build()
        
        let iterations = 1000
        let startTime = CFAbsoluteTimeGetCurrent()
        
        // ë²¤ì¹˜ë§ˆí¬ ì‹¤í–‰
        for i in 0..<iterations {
            _ = await monitor.measureResolution(keyName: "Layer3Service\(i)") {
                try await container.resolve(Layer3ServiceKey.self)
            }
            
            if i % 100 == 0 {
                await monitor.recordMemoryUsage()
            }
        }
        
        let totalDuration = CFAbsoluteTimeGetCurrent() - startTime
        let report = await monitor.generatePerformanceReport()
        
        print("ğŸ† ì „ì²´ ì‹œìŠ¤í…œ ì„±ëŠ¥ ë²¤ì¹˜ë§ˆí¬:")
        print("- ì´ í•´ê²° íšŸìˆ˜: \(iterations)")
        print("- ì´ ì†Œìš” ì‹œê°„: \(String(format: "%.3f", totalDuration))ì´ˆ")
        print("- í‰ê·  í•´ê²° ì‹œê°„: \(String(format: "%.3f", report.averageResolutionTime * 1000))ms")
        print("- ëŠë¦° í•´ê²° íšŸìˆ˜: \(report.slowResolutions.count)")
        print("- í‰ê·  ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰: \(report.averageMemoryUsage / (1024*1024))MB")
        print("- ìµœëŒ€ ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰: \(report.peakMemoryUsage / (1024*1024))MB")
        
        // ì„±ëŠ¥ ê¸°ì¤€ ê²€ì¦
        #expect(report.averageResolutionTime < 0.001, "í‰ê·  í•´ê²° ì‹œê°„ì´ 1msë¥¼ ì´ˆê³¼í•©ë‹ˆë‹¤")
        #expect(report.slowResolutions.count < iterations * 0.05, "ëŠë¦° í•´ê²°ì´ 5%ë¥¼ ì´ˆê³¼í•©ë‹ˆë‹¤")
        
        await container.shutdown()
    }
    
    // MARK: - í”Œë«í¼ í˜¸í™˜ì„± ê²€ì¦
    
    @Test("í¬ë¡œìŠ¤ í”Œë«í¼ í˜¸í™˜ì„± ê²€ì¦")
    func testCrossPlatformCompatibility() async throws {
        // PlatformAppropriateLock ë™ì‘ í™•ì¸
        let lock = PlatformAppropriateLock(initialState: 0)
        let lockInfo = lock.lockMechanismInfo
        
        print("ğŸ”’ í”Œë«í¼ ì ê¸ˆ ë©”ì»¤ë‹ˆì¦˜: \(lockInfo)")
        
        // ë™ê¸° ì»¨í…Œì´ë„ˆ iOS 15/16 í˜¸í™˜ì„±
        let syncContainer = WeaverSyncContainer.builder()
            .register(ServiceKey.self) { _ in TestService() }
            .build()
        
        let service = try await syncContainer.resolve(ServiceKey.self)
        #expect(service.isDefaultValue == false)
        
        // ë¹„ë™ê¸° ì»¨í…Œì´ë„ˆ í˜¸í™˜ì„±
        let asyncContainer = await WeaverContainer.builder()
            .register(ServiceKey.self) { _ in TestService() }
            .build()
        
        let asyncService = try await asyncContainer.resolve(ServiceKey.self)
        #expect(asyncService.isDefaultValue == false)
        
        await asyncContainer.shutdown()
    }
}

// MARK: - í…ŒìŠ¤íŠ¸ ì§€ì› íƒ€ì…ë“¤

extension SystemIntegrationTests {
    
    // 8ê³„ì¸µ ëª¨ë“ˆ ì •ì˜
    struct LoggingModule: Module {
        func configure(_ builder: WeaverBuilder) async {
            await builder.register(LoggerServiceKey.self, scope: .appService) { _ in
                LoggerService()
            }
        }
    }
    
    struct ConfigModule: Module {
        func configure(_ builder: WeaverBuilder) async {
            await builder.register(ConfigServiceKey.self, scope: .appService) { _ in
                ConfigService()
            }
        }
    }
    
    struct AnalyticsModule: Module {
        func configure(_ builder: WeaverBuilder) async {
            await builder.register(AnalyticsServiceKey.self, scope: .appService) { _ in
                AnalyticsService()
            }
        }
    }
    
    struct NetworkModule: Module {
        func configure(_ builder: WeaverBuilder) async {
            await builder.register(NetworkServiceKey.self, scope: .appService) { _ in
                NetworkService()
            }
        }
    }
    
    struct SecurityModule: Module {
        func configure(_ builder: WeaverBuilder) async {
            await builder.register(SecurityServiceKey.self, scope: .appService) { _ in
                SecurityService()
            }
        }
    }
    
    struct DataModule: Module {
        func configure(_ builder: WeaverBuilder) async {
            await builder.register(DataServiceKey.self, scope: .appService) { _ in
                DataService()
            }
        }
    }
    
    struct BusinessModule: Module {
        func configure(_ builder: WeaverBuilder) async {
            await builder.register(BusinessServiceKey.self, scope: .appService) { _ in
                BusinessService()
            }
        }
    }
    
    struct UIModule: Module {
        func configure(_ builder: WeaverBuilder) async {
            await builder.register(UIServiceKey.self, scope: .appService) { _ in
                UIService()
            }
        }
    }
    
    // DependencyKey ì •ì˜ë“¤
    struct ServiceKey: DependencyKey {
        typealias Value = Service
        static var defaultValue: Service { NullService(isDefaultValue: true) }
    }
    
    struct TransientServiceKey: DependencyKey {
        typealias Value = Service
        static var defaultValue: Service { NullService(isDefaultValue: true) }
    }
    
    struct WeakServiceKey: DependencyKey {
        typealias Value = WeakService
        static var defaultValue: WeakService { WeakService(isDefaultValue: true) }
    }
    
    // 8ê³„ì¸µ ì„œë¹„ìŠ¤ í‚¤ë“¤
    struct LoggerServiceKey: DependencyKey {
        typealias Value = LoggerService
        static var defaultValue: LoggerService { LoggerService() }
    }
    
    struct ConfigServiceKey: DependencyKey {
        typealias Value = ConfigService
        static var defaultValue: ConfigService { ConfigService() }
    }
    
    struct AnalyticsServiceKey: DependencyKey {
        typealias Value = AnalyticsService
        static var defaultValue: AnalyticsService { AnalyticsService() }
    }
    
    struct NetworkServiceKey: DependencyKey {
        typealias Value = NetworkService
        static var defaultValue: NetworkService { NetworkService() }
    }
    
    struct SecurityServiceKey: DependencyKey {
        typealias Value = SecurityService
        static var defaultValue: SecurityService { SecurityService() }
    }
    
    struct DataServiceKey: DependencyKey {
        typealias Value = DataService
        static var defaultValue: DataService { DataService() }
    }
    
    struct BusinessServiceKey: DependencyKey {
        typealias Value = BusinessService
        static var defaultValue: BusinessService { BusinessService() }
    }
    
    struct UIServiceKey: DependencyKey {
        typealias Value = UIService
        static var defaultValue: UIService { UIService() }
    }
    
    // ë™ì  ì„œë¹„ìŠ¤ í‚¤ë“¤
    struct DynamicServiceKey: DependencyKey {
        let id: Int
        
        init(id: Int) {
            self.id = id
        }
        
        typealias Value = DynamicService
        static var defaultValue: DynamicService { DynamicService(id: -1) }
    }
    
    struct ChainedServiceKey: DependencyKey {
        let id: Int
        
        init(id: Int) {
            self.id = id
        }
        
        typealias Value = ChainedService
        static var defaultValue: ChainedService { ChainedService(id: -1, dependency: nil) }
    }
    
    // ì—ëŸ¬ ë³µêµ¬ í…ŒìŠ¤íŠ¸ìš© í‚¤ë“¤
    struct ReliableServiceKey: DependencyKey {
        typealias Value = ReliableService
        static var defaultValue: ReliableService { ReliableService() }
    }
    
    struct UnreliableServiceKey: DependencyKey {
        typealias Value = UnreliableService
        static var defaultValue: UnreliableService { UnreliableService() }
    }
    
    struct DependentServiceKey: DependencyKey {
        typealias Value = DependentService
        static var defaultValue: DependentService { 
            DependentService(reliable: ReliableService(), unreliable: nil) 
        }
    }
    
    // ê³„ì¸µ ì„œë¹„ìŠ¤ í‚¤ë“¤
    struct Layer0ServiceKey: DependencyKey {
        typealias Value = Layer0Service
        static var defaultValue: Layer0Service { Layer0Service() }
    }
    
    struct Layer1ServiceKey: DependencyKey {
        typealias Value = Layer1Service
        static var defaultValue: Layer1Service { Layer1Service(dependency: Layer0Service()) }
    }
    
    struct Layer2ServiceKey: DependencyKey {
        typealias Value = Layer2Service
        static var defaultValue: Layer2Service { Layer2Service(dependency: Layer1Service(dependency: Layer0Service())) }
    }
    
    struct Layer3ServiceKey: DependencyKey {
        typealias Value = Layer3Service
        static var defaultValue: Layer3Service { 
            Layer3Service(dependency: Layer2Service(dependency: Layer1Service(dependency: Layer0Service()))) 
        }
    }
    
    // ì„œë¹„ìŠ¤ êµ¬í˜„ë“¤
    final class LoggerService: Sendable { init() {} }
    final class ConfigService: Sendable { init() {} }
    final class AnalyticsService: Sendable { init() {} }
    final class NetworkService: Sendable { init() {} }
    final class SecurityService: Sendable { init() {} }
    final class DataService: Sendable { init() {} }
    final class BusinessService: Sendable { init() {} }
    final class UIService: Sendable { init() {} }
    
    final class DynamicService: Sendable {
        let id: Int
        init(id: Int) { self.id = id }
    }
    
    final class ChainedService: Sendable {
        let id: Int
        let dependency: ChainedService?
        init(id: Int, dependency: ChainedService?) {
            self.id = id
            self.dependency = dependency
        }
    }
    
    final class ReliableService: Sendable { init() {} }
    final class UnreliableService: Sendable { init() {} }
    
    final class DependentService: Sendable {
        let reliable: ReliableService
        let unreliable: UnreliableService?
        init(reliable: ReliableService, unreliable: UnreliableService?) {
            self.reliable = reliable
            self.unreliable = unreliable
        }
    }
    
    final class Layer0Service: Sendable { init() {} }
    final class Layer1Service: Sendable {
        let dependency: Layer0Service
        init(dependency: Layer0Service) { self.dependency = dependency }
    }
    final class Layer2Service: Sendable {
        let dependency: Layer1Service
        init(dependency: Layer1Service) { self.dependency = dependency }
    }
    final class Layer3Service: Sendable {
        let dependency: Layer2Service
        init(dependency: Layer2Service) { self.dependency = dependency }
    }
}