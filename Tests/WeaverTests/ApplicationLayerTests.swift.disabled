import Testing
import Foundation
@testable import Weaver

#if canImport(SwiftUI)
import SwiftUI

// MARK: - Application Layer í…ŒìŠ¤íŠ¸

@available(iOS 13.0, macOS 10.15, tvOS 13.0, watchOS 6.0, *)
@Suite("Application Layer - SwiftUI í†µí•© ë° ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§")
struct ApplicationLayerTests {
    
    // MARK: - SwiftUI í†µí•© í…ŒìŠ¤íŠ¸
    
    @Test("WeaverViewModifier ìƒíƒœ ê´€ë¦¬")
    func testWeaverViewModifierStateManagement() async throws {
        let modules = [TestModule()]
        let modifier = WeaverViewModifier(modules: modules, setAsGlobal: false)
        
        // ViewModifierëŠ” ì‹¤ì œ SwiftUI í™˜ê²½ì—ì„œë§Œ ì™„ì „íˆ í…ŒìŠ¤íŠ¸ ê°€ëŠ¥
        // ì—¬ê¸°ì„œëŠ” ì´ˆê¸°í™”ê°€ ì„±ê³µí•˜ëŠ”ì§€ë§Œ í™•ì¸
        #expect(modules.count == 1)
    }
    
    @Test("Preview í™˜ê²½ í˜¸í™˜ì„±")
    func testPreviewEnvironmentCompatibility() async throws {
        // Preview í™˜ê²½ì—ì„œëŠ” ê¸°ë³¸ê°’ì´ ë°˜í™˜ë˜ì–´ì•¼ í•¨
        let previewModule = PreviewWeaverContainer.previewModule(
            ServiceKey.self,
            mockValue: TestService(isDefaultValue: false)
        )
        
        // ëª¨ë“ˆì´ ì˜¬ë°”ë¥´ê²Œ ìƒì„±ë˜ëŠ”ì§€ í™•ì¸
        let builder = WeaverContainer.builder()
        await previewModule.configure(builder)
        
        let container = await builder.build()
        let service = try await container.resolve(ServiceKey.self)
        #expect(service.isDefaultValue == false)
        
        await container.shutdown()
    }
    
    // MARK: - ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§ í…ŒìŠ¤íŠ¸
    
    @Test("ì„±ëŠ¥ ëª¨ë‹ˆí„° ë©”íŠ¸ë¦­ ìˆ˜ì§‘")
    func testPerformanceMonitorMetricsCollection() async throws {
        let monitor = WeaverPerformanceMonitor(enabled: true)
        
        // ì„±ëŠ¥ ì¸¡ì • ì‹¤í–‰
        let result = try await monitor.measureResolution(keyName: "TestService") {
            // ì‹œë®¬ë ˆì´ì…˜ëœ ì‘ì—…
            try await Task.sleep(nanoseconds: 10_000_000) // 10ms
            return TestService()
        }
        
        #expect(result.isDefaultValue == false)
        
        // ì„±ëŠ¥ ë³´ê³ ì„œ ìƒì„±
        let report = await monitor.generatePerformanceReport()
        #expect(report.totalResolutions == 1)
        #expect(report.averageResolutionTime > 0)
        
        print("ğŸ“Š ì„±ëŠ¥ ë³´ê³ ì„œ: \(report)")
    }
    
    @Test("ëŠë¦° í•´ê²° ê°ì§€")
    func testSlowResolutionDetection() async throws {
        let monitor = WeaverPerformanceMonitor(enabled: true)
        
        // ì˜ë„ì ìœ¼ë¡œ ëŠë¦° ì‘ì—…
        _ = try await monitor.measureResolution(keyName: "SlowService") {
            try await Task.sleep(nanoseconds: 150_000_000) // 150ms (ì„ê³„ê°’ 100ms ì´ˆê³¼)
            return TestService()
        }
        
        let report = await monitor.generatePerformanceReport()
        #expect(report.slowResolutions.count == 1)
        #expect(report.slowResolutions.first?.keyName == "SlowService")
        #expect(report.slowResolutions.first?.duration ?? 0 > 0.1)
    }
    
    @Test("ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ì¶”ì ")
    func testMemoryUsageTracking() async throws {
        let monitor = WeaverPerformanceMonitor(enabled: true)
        
        // ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ê¸°ë¡
        await monitor.recordMemoryUsage()
        
        // ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ì„ ì¦ê°€ì‹œí‚¤ëŠ” ì‘ì—…
        var largeArray: [Data] = []
        for _ in 0..<100 {
            largeArray.append(Data(count: 1024 * 1024)) // 1MBì”©
        }
        
        await monitor.recordMemoryUsage()
        
        // ë©”ëª¨ë¦¬ í•´ì œ
        largeArray.removeAll()
        
        let report = await monitor.generatePerformanceReport()
        #expect(report.peakMemoryUsage > report.averageMemoryUsage)
        
        print("ğŸ’¾ ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ - í‰ê· : \(report.averageMemoryUsage / (1024*1024))MB, ìµœëŒ€: \(report.peakMemoryUsage / (1024*1024))MB")
    }
    
    @Test("ì„±ëŠ¥ ëª¨ë‹ˆí„° ë¹„í™œì„±í™” ìƒíƒœ")
    func testPerformanceMonitorDisabled() async throws {
        let monitor = WeaverPerformanceMonitor(enabled: false)
        
        // ë¹„í™œì„±í™”ëœ ìƒíƒœì—ì„œ ì¸¡ì •
        let result = await monitor.measureResolution(keyName: "TestService") {
            return TestService()
        }
        
        #expect(result.isDefaultValue == false)
        
        // ë³´ê³ ì„œëŠ” ë¹ˆ ìƒíƒœì—¬ì•¼ í•¨
        let report = await monitor.generatePerformanceReport()
        #expect(report.totalResolutions == 0)
        #expect(report.averageResolutionTime == 0)
    }
    
    @Test("ì„±ëŠ¥ ë°ì´í„° ì´ˆê¸°í™”")
    func testPerformanceDataReset() async throws {
        let monitor = WeaverPerformanceMonitor(enabled: true)
        
        // ë°ì´í„° ìƒì„±
        await monitor.measureResolution(keyName: "TestService") {
            return TestService()
        }
        await monitor.recordMemoryUsage()
        
        // ì´ˆê¸° ë³´ê³ ì„œ í™•ì¸
        let initialReport = await monitor.generatePerformanceReport()
        #expect(initialReport.totalResolutions == 1)
        
        // ë°ì´í„° ì´ˆê¸°í™”
        await monitor.reset()
        
        // ì´ˆê¸°í™” í›„ ë³´ê³ ì„œ í™•ì¸
        let resetReport = await monitor.generatePerformanceReport()
        #expect(resetReport.totalResolutions == 0)
        #expect(resetReport.averageResolutionTime == 0)
    }
    
    // MARK: - í†µí•© ì„±ëŠ¥ í…ŒìŠ¤íŠ¸
    
    @Test("ì‹¤ì œ DI ì»¨í…Œì´ë„ˆì™€ ì„±ëŠ¥ ëª¨ë‹ˆí„° í†µí•©")
    func testDIContainerPerformanceIntegration() async throws {
        let monitor = WeaverPerformanceMonitor(enabled: true)
        
        let container = await WeaverContainer.builder()
            .register(ServiceKey.self) { _ in
                // ì‹œë®¬ë ˆì´ì…˜ëœ ì´ˆê¸°í™” ì‹œê°„
                try await Task.sleep(nanoseconds: 5_000_000) // 5ms
                return TestService()
            }
            .register(AnotherServiceKey.self, scope: .container) { _ in
                return AnotherService()
            }
            .build()
        
        // ì„±ëŠ¥ ì¸¡ì •ê³¼ í•¨ê»˜ ì˜ì¡´ì„± í•´ê²°
        let service1 = await monitor.measureResolution(keyName: "ServiceKey") {
            try await container.resolve(ServiceKey.self)
        }
        
        let service2 = await monitor.measureResolution(keyName: "ServiceKey") {
            try await container.resolve(ServiceKey.self)
        }
        
        let anotherService = await monitor.measureResolution(keyName: "AnotherServiceKey") {
            try await container.resolve(AnotherServiceKey.self)
        }
        
        #expect(service1.isDefaultValue == false)
        #expect(service2.isDefaultValue == false)
        #expect(anotherService is AnotherService)
        
        // ì„±ëŠ¥ ë³´ê³ ì„œ ë¶„ì„
        let report = await monitor.generatePerformanceReport()
        #expect(report.totalResolutions == 3)
        
        print("ğŸš€ DI ì„±ëŠ¥ ë³´ê³ ì„œ:")
        print(report.description)
        
        await container.shutdown()
    }
    
    // MARK: - ë©”ëª¨ë¦¬ ì••ë°• ì‹œë‚˜ë¦¬ì˜¤ í…ŒìŠ¤íŠ¸
    
    @Test("ë©”ëª¨ë¦¬ ì••ë°• ìƒí™©ì—ì„œ ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§")
    func testPerformanceMonitoringUnderMemoryPressure() async throws {
        let monitor = WeaverPerformanceMonitor(enabled: true)
        
        let container = await WeaverContainer.builder()
            .registerWeak(WeakServiceKey.self) { _ in WeakService() }
            .build()
        
        // ëŒ€ëŸ‰ ì¸ìŠ¤í„´ìŠ¤ ìƒì„±ìœ¼ë¡œ ë©”ëª¨ë¦¬ ì••ë°• ìœ ë„
        var instances: [WeakService] = []
        for i in 0..<1000 {
            let instance = await monitor.measureResolution(keyName: "WeakService\(i)") {
                try await container.resolve(WeakServiceKey.self)
            }
            instances.append(instance)
            
            // ì£¼ê¸°ì ìœ¼ë¡œ ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ê¸°ë¡
            if i % 100 == 0 {
                await monitor.recordMemoryUsage()
            }
        }
        
        // ë©”ëª¨ë¦¬ í•´ì œ
        instances.removeAll()
        await container.performMemoryCleanup(forced: true)
        await monitor.recordMemoryUsage()
        
        // ì„±ëŠ¥ ë¶„ì„
        let report = await monitor.generatePerformanceReport()
        #expect(report.totalResolutions == 1000)
        
        let memoryIncreaseMB = (report.peakMemoryUsage - report.averageMemoryUsage) / (1024 * 1024)
        print("ğŸ“ˆ ë©”ëª¨ë¦¬ ì¦ê°€ëŸ‰: \(memoryIncreaseMB)MB")
        
        await container.shutdown()
    }
    
    // MARK: - ë²¤ì¹˜ë§ˆí¬ í…ŒìŠ¤íŠ¸
    
    @Test("ì˜ì¡´ì„± í•´ê²° ì„±ëŠ¥ ë²¤ì¹˜ë§ˆí¬")
    func benchmarkDependencyResolutionPerformance() async throws {
        let monitor = WeaverPerformanceMonitor(enabled: true)
        
        let container = await WeaverContainer.builder()
            .register(ServiceKey.self, scope: .container) { _ in TestService() }
            .build()
        
        let iterations = 1000
        let startTime = CFAbsoluteTimeGetCurrent()
        
        for i in 0..<iterations {
            _ = await monitor.measureResolution(keyName: "Benchmark\(i)") {
                try await container.resolve(ServiceKey.self)
            }
        }
        
        let totalDuration = CFAbsoluteTimeGetCurrent() - startTime
        let averageTime = totalDuration / Double(iterations) * 1000 // ms
        
        let report = await monitor.generatePerformanceReport()
        
        print("âš¡ ë²¤ì¹˜ë§ˆí¬ ê²°ê³¼:")
        print("- ì´ í•´ê²° íšŸìˆ˜: \(iterations)")
        print("- ì´ ì†Œìš” ì‹œê°„: \(String(format: "%.3f", totalDuration))ì´ˆ")
        print("- í‰ê·  í•´ê²° ì‹œê°„: \(String(format: "%.3f", averageTime))ms")
        print("- ëª¨ë‹ˆí„° í‰ê·  ì‹œê°„: \(String(format: "%.3f", report.averageResolutionTime * 1000))ms")
        
        #expect(averageTime < 1.0, "í‰ê·  í•´ê²° ì‹œê°„ì´ 1msë¥¼ ì´ˆê³¼í•©ë‹ˆë‹¤: \(averageTime)ms")
        
        await container.shutdown()
    }
}

// MARK: - í…ŒìŠ¤íŠ¸ ì§€ì› íƒ€ì…ë“¤

@available(iOS 13.0, macOS 10.15, tvOS 13.0, watchOS 6.0, *)
extension ApplicationLayerTests {
    
    // DependencyKey ì •ì˜ë“¤
    struct ServiceKey: DependencyKey {
        typealias Value = Service
        static var defaultValue: Service { NullService(isDefaultValue: true) }
    }
    
    struct AnotherServiceKey: DependencyKey {
        typealias Value = AnotherService
        static var defaultValue: AnotherService { AnotherService(isDefaultValue: true) }
    }
    
    struct WeakServiceKey: DependencyKey {
        typealias Value = WeakService
        static var defaultValue: WeakService { WeakService(isDefaultValue: true) }
    }
    
    // í…ŒìŠ¤íŠ¸ìš© ëª¨ë“ˆ
    struct TestModule: Module {
        func configure(_ builder: WeaverBuilder) async {
            await builder.register(ServiceKey.self) { _ in TestService() }
        }
    }
}

#else

// SwiftUIë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ëŠ” í™˜ê²½ì—ì„œëŠ” ë¹ˆ í…ŒìŠ¤íŠ¸ ìŠ¤ìœ„íŠ¸
@Suite("Application Layer - SwiftUI í†µí•© ë° ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§")
struct ApplicationLayerTests {
    
    @Test("SwiftUI ë¯¸ì§€ì› í™˜ê²½")
    func testSwiftUINotAvailable() async throws {
        // SwiftUIê°€ ì§€ì›ë˜ì§€ ì•ŠëŠ” í™˜ê²½
        #expect(Bool(true), "SwiftUIê°€ ì§€ì›ë˜ì§€ ì•ŠëŠ” í™˜ê²½ì…ë‹ˆë‹¤")
    }
}

#endif